<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Sohbet Görüntüleyici</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="chat-header">
            <div class="chat-info">
                <div class="avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="chat-details">
                    <h3>WhatsApp Chat</h3>
                    <span class="status">Sohbet görüntüleyici</span>
                </div>
            </div>
            <div class="header-actions">
                <button class="action-btn" onclick="toggleTheme()">
                    <i class="fas fa-moon"></i>
                </button>
                <button class="action-btn" onclick="exportChat()">
                    <i class="fas fa-download"></i>
                </button>
            </div>
        </div>

        <!-- Chat Messages -->
        <div class="chat-messages" id="chatMessages">
            <div class="loading">
                <i class="fas fa-comments"></i>
                <p>Henüz mesaj yok. Sohbet dosyası yükleyin.</p>
            </div>
        </div>

        <!-- File Upload -->
        <div class="file-upload">
            <input type="file" id="chatFile" accept=".txt,.jpg,.jpeg,.png,.gif,.mp4,.avi,.mov,.pdf,.doc,.docx,.zip,.rar,.vcf,.opus,.mp3,.wav,.m4a,.ogg,.aac" style="display: none;" multiple>
            <button class="upload-btn" onclick="document.getElementById('chatFile').click()">
                <i class="fas fa-upload"></i>
                Sohbet Dosyalarını Yükle
            </button>
            <span class="upload-hint">_chat.txt ve medya dosyalarını seçin (birden fazla dosya seçebilirsiniz)</span>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="modal" id="imageModal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <img id="modalImage" src="" alt="Resim">
        </div>
    </div>

    <!-- Fast Scroll Indicator -->
    <div class="scroll-indicator" id="scrollIndicator">
        <i class="fas fa-chevron-up"></i> Hızlı Kaydırma <i class="fas fa-chevron-down"></i>
    </div>

    <script>
        // Basit çalışan versiyon
        let chatData = [];
        let chatParticipants = new Set();

        // DOM elements
        const chatMessages = document.getElementById('chatMessages');
        const chatFileInput = document.getElementById('chatFile');
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Load default chat if available
            loadDefaultChat();
            
            // File upload listener
            chatFileInput.addEventListener('change', handleFileUpload);
            
            // Modal close listeners
            document.querySelector('.close').addEventListener('click', closeModal);
            imageModal.addEventListener('click', function(e) {
                if (e.target === imageModal) {
                    closeModal();
                }
            });
            
            // Optimize scroll performance
            let scrollTimeout;
            chatMessages.addEventListener('scroll', function() {
                // Throttle scroll events for better performance
                if (scrollTimeout) {
                    clearTimeout(scrollTimeout);
                }
                scrollTimeout = setTimeout(() => {
                    // Handle scroll events here if needed
                }, 16); // ~60fps
            }, { passive: true });
            
            // Fast scroll functionality
            setupFastScroll();
        });
        
        // Setup fast scroll functionality
        function setupFastScroll() {
            const scrollIndicator = document.getElementById('scrollIndicator');
            let isFastScrollActive = false;
            
            // Keyboard shortcuts for fast scroll
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Shift') {
                    activateFastScroll();
                }
                
                // Page Up/Down for fast scroll
                if (e.key === 'PageUp') {
                    e.preventDefault();
                    chatMessages.scrollTop -= chatMessages.clientHeight;
                }
                
                if (e.key === 'PageDown') {
                    e.preventDefault();
                    chatMessages.scrollTop += chatMessages.clientHeight;
                }
                
                // Home/End for quick navigation
                if (e.key === 'Home') {
                    e.preventDefault();
                    chatMessages.scrollTop = 0;
                }
                
                if (e.key === 'End') {
                    e.preventDefault();
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            });
            
            document.addEventListener('keyup', function(e) {
                if (e.key === 'Shift') {
                    deactivateFastScroll();
                }
            });
            
            // Mouse wheel for fast scroll
            chatMessages.addEventListener('wheel', function(e) {
                if (e.shiftKey) {
                    e.preventDefault();
                    // Fast scroll with mouse wheel
                    const scrollAmount = e.deltaY * 3; // 3x faster
                    chatMessages.scrollTop += scrollAmount;
                    showScrollIndicator();
                }
            }, { passive: false });
            
            function activateFastScroll() {
                if (!isFastScrollActive) {
                    isFastScrollActive = true;
                    chatMessages.classList.add('fast-scroll');
                    showScrollIndicator();
                }
            }
            
            function deactivateFastScroll() {
                if (isFastScrollActive) {
                    isFastScrollActive = false;
                    chatMessages.classList.remove('fast-scroll');
                    hideScrollIndicator();
                }
            }
            
            function showScrollIndicator() {
                scrollIndicator.classList.add('show');
                setTimeout(() => {
                    scrollIndicator.classList.remove('show');
                }, 2000);
            }
            
            function hideScrollIndicator() {
                scrollIndicator.classList.remove('show');
            }
        }
        });

        // Load default chat from _chat.txt
        async function loadDefaultChat() {
            try {
                const response = await fetch('_chat.txt');
                if (response.ok) {
                    const text = await response.text();
                    parseChatFile(text);
                    displayMessages();
                }
            } catch (error) {
                console.log('Default chat file not found, waiting for user upload');
            }
        }

        // Handle file upload
        function handleFileUpload(event) {
            const files = event.target.files;
            
            if (files.length === 0) return;
            
            console.log('Uploading', files.length, 'files...');
            
            let chatFile = null;
            const imageFiles = [];
            
            // Separate chat file and media files
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                console.log('Processing file:', file.name, 'Type:', file.type, 'Size:', file.size);
                
                if (file.name === '_chat.txt' || file.name.endsWith('.txt')) {
                    chatFile = file;
                    console.log('Found chat file:', file.name);
                } else if (file.type.startsWith('image/') || file.type.startsWith('video/') || file.type.startsWith('audio/') || 
                           file.name.match(/\.(jpg|jpeg|png|gif|mp4|avi|mov|pdf|doc|docx|txt|zip|rar|vcf|opus|mp3|wav|m4a|ogg|aac)$/i)) {
                    imageFiles.push(file);
                    console.log('Found media file:', file.name);
                } else {
                    console.log('Unknown file type:', file.name);
                }
            }
            
            // Process media files first
            if (imageFiles.length > 0) {
                processImageFiles(imageFiles);
            }
            
            // Process chat file
            if (chatFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    parseChatFile(e.target.result);
                    displayMessages();
                };
                reader.readAsText(chatFile);
            }
        }

        // Parse WhatsApp chat file
        function parseChatFile(text) {
            const lines = text.split('\n');
            chatData = [];
            chatParticipants.clear();
            
            let currentMessage = null;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // Check if this line starts a new message
                const messageMatch = line.match(/^\[(\d{1,2}\/\d{1,2}\/\d{2,4}\s+\d{1,2}:\d{2}:\d{2})\]\s+(.+?):\s*(.*)/);
                
                if (messageMatch) {
                    // Save previous message if exists
                    if (currentMessage) {
                        chatData.push(currentMessage);
                    }
                    
                    // Start new message
                    const [, timestamp, sender, content] = messageMatch;
                    const senderName = sender.trim();
                    
                    // Add sender to participants
                    chatParticipants.add(senderName);
                    
                    currentMessage = {
                        timestamp: parseTimestamp(timestamp),
                        sender: senderName,
                        content: content.trim(),
                        type: getMessageType(content)
                    };
                } else if (currentMessage) {
                    // This line is continuation of current message
                    currentMessage.content += '\n' + line;
                    // Update message type based on new content
                    currentMessage.type = getMessageType(currentMessage.content);
                }
            }
            
            // Add the last message
            if (currentMessage) {
                chatData.push(currentMessage);
            }
            
            // Sort messages by timestamp
            chatData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            // Update header with participants
            updateChatHeader();
        }

        // Display messages with virtual scrolling for better performance
        function displayMessages() {
            if (chatData.length === 0) {
                chatMessages.innerHTML = `
                    <div class="loading">
                        <i class="fas fa-comments"></i>
                        <p>Henüz mesaj yok. Sohbet dosyası yükleyin.</p>
                    </div>
                `;
                return;
            }
            
            // Clear container
            chatMessages.innerHTML = '';
            
            // Add scroll performance optimization
            chatMessages.style.pointerEvents = 'none';
            
            // Use requestAnimationFrame for smooth rendering
            requestAnimationFrame(() => {
                // Use DocumentFragment for better performance
                const fragment = document.createDocumentFragment();
                
                // Process messages in chunks for better performance
                const chunkSize = 50;
                let currentIndex = 0;
                
                function processChunk() {
                    const endIndex = Math.min(currentIndex + chunkSize, chatData.length);
                    
                    for (let i = currentIndex; i < endIndex; i++) {
                        const messageElement = createMessageElement(chatData[i]);
                        fragment.appendChild(messageElement);
                    }
                    
                    currentIndex = endIndex;
                    
                    if (currentIndex < chatData.length) {
                        // Process next chunk
                        requestAnimationFrame(processChunk);
                    } else {
                        // All chunks processed, append to DOM
                        chatMessages.appendChild(fragment);
                        chatMessages.style.pointerEvents = 'auto';
                        
                        // Scroll to bottom
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                }
                
                processChunk();
            });
        }

        // Create message element with performance optimizations
        function createMessageElement(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.sender === 'Salih Güngör' ? 'sent' : 'received'}`;
            
            // Performance optimization: use transform instead of changing layout
            messageDiv.style.transform = 'translateZ(0)';
            
            const timeString = formatTime(message.timestamp);
            
            // Add fast scroll to message content if it's long
            const isLongMessage = message.content.length > 200 || message.content.includes('\n');
            
            switch (message.type) {
                case 'image':
                    const imagePath = getMediaPath(message.content);
                    messageDiv.innerHTML = `
                        <div class="message-content">
                            <div class="media-message image">
                                <img src="${imagePath}" alt="Resim" class="message-image" onclick="openImageModal('${imagePath}')" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <div class="image-error" style="display: none; padding: 20px; text-align: center; color: #666;">
                                    <i class="fas fa-image"></i>
                                    <p>Resim yüklenemedi</p>
                                </div>
                            </div>
                        </div>
                        <div class="message-time">${timeString}</div>
                    `;
                    break;
                    
                case 'video':
                    const videoPath = getMediaPath(message.content);
                    messageDiv.innerHTML = `
                        <div class="message-content">
                            <div class="media-message video">
                                <i class="fas fa-video"></i>
                                <span>Video</span>
                                <div class="file-name">${videoPath}</div>
                            </div>
                        </div>
                        <div class="message-time">${timeString}</div>
                    `;
                    break;
                    
                case 'document':
                    const docName = getMediaPath(message.content);
                    messageDiv.innerHTML = `
                        <div class="message-content">
                            <div class="media-message document">
                                <i class="fas fa-file"></i>
                                <span>Dosya</span>
                                <div class="file-name">${docName}</div>
                            </div>
                        </div>
                        <div class="message-time">${timeString}</div>
                    `;
                    break;
                    
                case 'contact':
                    const contactName = getMediaPath(message.content);
                    messageDiv.innerHTML = `
                        <div class="message-content">
                            <div class="media-message contact">
                                <i class="fas fa-address-card"></i>
                                <span>Kişi kartı</span>
                                <div class="file-name">${contactName}</div>
                            </div>
                        </div>
                        <div class="message-time">${timeString}</div>
                    `;
                    break;
                    
                case 'audio':
                    const audioPath = getMediaPath(message.content);
                    messageDiv.innerHTML = `
                        <div class="message-content">
                            <div class="media-message audio">
                                <i class="fas fa-microphone"></i>
                                <span>Ses mesajı</span>
                                <div class="file-name">${audioPath}</div>
                                <audio controls style="width: 100%; margin-top: 8px;">
                                    <source src="${audioPath}" type="audio/${getAudioType(audioPath)}">
                                    Tarayıcınız ses dosyasını desteklemiyor.
                                </audio>
                            </div>
                        </div>
                        <div class="message-time">${timeString}</div>
                    `;
                    break;
                    
                default:
                    const contentClass = isLongMessage ? 'message-content fast-scroll' : 'message-content';
                    messageDiv.innerHTML = `
                        <div class="${contentClass}">${escapeHtml(message.content).replace(/\n/g, '<br>')}</div>
                        <div class="message-time">${timeString}</div>
                    `;
            }
            
            return messageDiv;
        }

        // Get message type
        function getMessageType(content) {
            if (content.includes('<') && content.includes('.jpg eklendi>')) {
                return 'image';
            } else if (content.includes('<') && content.includes('.jpeg eklendi>')) {
                return 'image';
            } else if (content.includes('<') && content.includes('.png eklendi>')) {
                return 'image';
            } else if (content.includes('<') && content.includes('.gif eklendi>')) {
                return 'image';
            } else if (content.includes('<') && content.includes('.mp4 eklendi>')) {
                return 'video';
            } else if (content.includes('<') && content.includes('.avi eklendi>')) {
                return 'video';
            } else if (content.includes('<') && content.includes('.mov eklendi>')) {
                return 'video';
            } else if (content.includes('<') && content.includes('.pdf eklendi>')) {
                return 'document';
            } else if (content.includes('<') && content.includes('.doc eklendi>')) {
                return 'document';
            } else if (content.includes('<') && content.includes('.docx eklendi>')) {
                return 'document';
            } else if (content.includes('<') && content.includes('.zip eklendi>')) {
                return 'document';
            } else if (content.includes('<') && content.includes('.rar eklendi>')) {
                return 'document';
            } else if (content.includes('<') && content.includes('.vcf eklendi>')) {
                return 'contact';
            } else if (content.includes('<') && content.includes('.opus eklendi>')) {
                return 'audio';
            } else if (content.includes('<') && content.includes('.mp3 eklendi>')) {
                return 'audio';
            } else if (content.includes('<') && content.includes('.wav eklendi>')) {
                return 'audio';
            } else if (content.includes('<') && content.includes('.m4a eklendi>')) {
                return 'audio';
            } else if (content.includes('<') && content.includes('.ogg eklendi>')) {
                return 'audio';
            } else if (content.includes('<') && content.includes('.aac eklendi>')) {
                return 'audio';
            } else {
                return 'text';
            }
        }

        // Process image files and create virtual URLs
        function processImageFiles(imageFiles) {
            window.virtualImages = {};
            
            console.log('Processing', imageFiles.length, 'media files...');
            
            imageFiles.forEach(file => {
                const fileName = file.name;
                const virtualUrl = URL.createObjectURL(file);
                window.virtualImages[fileName] = virtualUrl;
                console.log('Processed media:', fileName, '->', virtualUrl);
            });
            
            console.log('Available virtual media:', Object.keys(window.virtualImages));
        }

        // Get media path from content
        function getMediaPath(content) {
            const match = content.match(/<(.+\.(jpg|jpeg|png|gif|mp4|avi|mov|pdf|doc|docx|txt|zip|rar|vcf|opus|mp3|wav|m4a|ogg|aac))\s+eklendi>/i);
            if (match) {
                const fileName = match[1];
                
                // Check if we have a virtual URL for this file
                if (window.virtualImages && window.virtualImages[fileName]) {
                    return window.virtualImages[fileName];
                }
                
                return fileName; // Fallback to direct file path
            }
            return '';
        }

        // Get audio type from file extension
        function getAudioType(fileName) {
            const extension = fileName.split('.').pop().toLowerCase();
            const audioTypes = {
                'opus': 'opus',
                'mp3': 'mpeg',
                'wav': 'wav',
                'm4a': 'mp4',
                'ogg': 'ogg',
                'aac': 'aac'
            };
            return audioTypes[extension] || 'mpeg';
        }

        // Parse timestamp
        function parseTimestamp(timestamp) {
            const [datePart, timePart] = timestamp.split(' ');
            const [day, month, year] = datePart.split('/');
            const [hour, minute, second] = timePart.split(':');
            
            // Handle 2-digit year
            const fullYear = year.length === 2 ? '20' + year : year;
            
            return new Date(fullYear, month - 1, day, hour, minute, second);
        }

        // Format time
        function formatTime(date) {
            return date.toLocaleString('tr-TR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Open image modal
        function openImageModal(imageSrc) {
            modalImage.src = imageSrc;
            imageModal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        // Close modal
        function closeModal() {
            imageModal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Toggle dark theme
        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            const icon = document.querySelector('.action-btn i');
            if (document.body.classList.contains('dark-theme')) {
                icon.className = 'fas fa-sun';
            } else {
                icon.className = 'fas fa-moon';
            }
        }

        // Export chat
        function exportChat() {
            if (chatData.length === 0) {
                alert('Dışa aktarılacak mesaj bulunamadı');
                return;
            }
            
            let exportText = `WhatsApp Sohbeti\n`;
            exportText += `Dışa aktarma tarihi: ${new Date().toLocaleString('tr-TR')}\n\n`;
            
            chatData.forEach(message => {
                const dateStr = message.timestamp.toLocaleDateString('tr-TR');
                const timeStr = message.timestamp.toLocaleTimeString('tr-TR');
                exportText += `[${dateStr} ${timeStr}] ${message.sender}: ${message.content}\n`;
            });
            
            const blob = new Blob([exportText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `whatsapp-chat-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Update chat header with participants
        function updateChatHeader() {
            const participants = Array.from(chatParticipants);
            if (participants.length > 0) {
                const headerTitle = document.querySelector('.chat-details h3');
                if (headerTitle) {
                    if (participants.length === 1) {
                        headerTitle.textContent = participants[0];
                    } else if (participants.length === 2) {
                        headerTitle.textContent = `${participants[0]} & ${participants[1]}`;
                    } else {
                        headerTitle.textContent = `${participants[0]} & ${participants.length - 1} kişi`;
                    }
                }
            }
        }
    </script>
</body>
</html>
